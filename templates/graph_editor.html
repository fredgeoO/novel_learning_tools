<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äº¤äº’å¼å›¾è°±ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/graph_editor.css') }}">

    <script src="{{ url_for('static', filename='js/floating_panel.js') }}"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1e1e1e;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            overflow: hidden;
        }
        #mynetwork {
            width: 100vw;
            height: 100vh;
            background-color: #1e1e1e;
        }
    </style>
</head>
<body>
    <div id="mynetwork"></div>

    <!-- æµ®åŠ¨æ§åˆ¶é¢æ¿ -->
    <div id="floating-control-section" class="floating-panel">
        <div class="panel-header">
            <h5>ğŸ“‹ æ§åˆ¶é¢æ¿</h5>
            <button id="hide-panel-btn" class="toggle-btn">âˆ’</button>
        </div>
        <div class="panel-content">
            <!-- å…ƒæ•°æ® -->
            <div class="control-panel">
                <h5>ğŸ“‹ å›¾è°±ä¿¡æ¯</h5>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="control-panel">
                <label>
                    <input type="checkbox" id="physicsToggle"> å¯ç”¨ç‰©ç†æ•ˆæœ
                </label>
                <button id="save-graph-btn" class="control-btn">ğŸ’¾ ä¿å­˜å›¾è°±</button>
                <button id="clear-graph-btn" class="control-btn">ğŸ—‘ï¸ æ¸…ç©ºå›¾è°±</button>
                <button id="export-graph-btn" class="control-btn">ğŸ“¤ å¯¼å‡ºå›¾è°±</button>
                <button id="refresh-graph-btn" class="control-btn">ğŸ”„ åˆ·æ–°å›¾è°±</button>
            </div>
        </div>
    </div>

    <!-- å±•å¼€æŒ‰é’® -->
    <div id="expand-panel-btn" class="expand-btn" style="display: none;">â˜°</div>


    <!-- Debug ä¿¡æ¯ -->
    <div id="debug-info" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(45, 45, 45, 0.9); padding: 8px; border-radius: 4px; color: white; font-size: 12px; min-width: 200px;"></div>

    <!-- èŠ‚ç‚¹å³é”®èœå• -->
    <div id="nodeContextMenu" class="context-menu">
        <ul>

            <li class="separator"></li>
            <li onclick="GraphEditor.showCreateNodeInput()">â• æ–°èŠ‚ç‚¹</li>
            <li onclick="GraphEditor.connectToExistingNodeMode()">ğŸ”— è¿æ¥èŠ‚ç‚¹</li>
            <li class="separator"></li>
            <li onclick="GraphEditor.showEditNodeLabelInput()">âœï¸ é‡å‘½å</li>
            <li onclick="GraphEditor.deleteSelectedNode()">âŒ åˆ é™¤</li>
        </ul>
    </div>

    <!-- è¾¹å³é”®èœå• -->
    <div id="edgeContextMenu" class="context-menu">
        <ul>
            <li onclick="GraphEditor.deleteSelectedEdge()">âŒ åˆ é™¤</li>
            <li onclick="GraphEditor.showEditEdgeLabelInput()">âœï¸ é‡å‘½å</li>
            <li onclick="GraphEditor.reverseEdgeDirection()">ğŸ”„ åè½¬</li>
        </ul>
    </div>

    <!-- åˆ›å»ºèŠ‚ç‚¹è¾“å…¥èœå• -->
    <div id="createNodeInput" class="input-menu">
        <div>åˆ›å»ºæ–°èŠ‚ç‚¹</div>
        <input type="text" id="newNodeLabel" placeholder="è¾“å…¥èŠ‚ç‚¹åç§°" value="æ–°èŠ‚ç‚¹">
        <div class="button-group">
            <button onclick="GraphEditor.cancelInput()">å–æ¶ˆ</button>
            <button onclick="GraphEditor.confirmCreateNode()">ç¡®å®š</button>
        </div>
    </div>

    <!-- ç¼–è¾‘èŠ‚ç‚¹æ ‡ç­¾è¾“å…¥èœå• -->
    <div id="editNodeLabelInput" class="input-menu">
        <div>ç¼–è¾‘èŠ‚ç‚¹æ ‡ç­¾</div>
        <input type="text" id="editNodeLabelText" placeholder="è¾“å…¥èŠ‚ç‚¹åç§°">
        <div class="button-group">
            <button onclick="GraphEditor.cancelInput()">å–æ¶ˆ</button>
            <button onclick="GraphEditor.confirmEditNodeLabel()">ç¡®å®š</button>
        </div>
    </div>

    <!-- ç¼–è¾‘è¾¹æ ‡ç­¾è¾“å…¥èœå• -->
    <div id="editEdgeLabelInput" class="input-menu">
        <div>ç¼–è¾‘è¾¹æ ‡ç­¾</div>
        <input type="text" id="editEdgeLabelText" placeholder="è¾“å…¥è¾¹æ ‡ç­¾">
        <div class="button-group">
            <button onclick="GraphEditor.cancelInput()">å–æ¶ˆ</button>
            <button onclick="GraphEditor.confirmEditEdgeLabel()">ç¡®å®š</button>
        </div>
    </div>

    <!-- è¿æ¥æ¨¡å¼æç¤º -->
    <div id="connectionHint" class="connection-hint">
        <div>è¯·ç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹ä»¥åˆ›å»ºè¿æ¥</div>
        <div style="font-size: 14px; margin-top: 8px; opacity: 0.8;">æŒ‰ ESC é”®å–æ¶ˆ</div>
    </div>

    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <script src="{{ url_for('static', filename='js/graph_editor.js') }}"></script>
    <script>
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– GraphEditor
    document.addEventListener('DOMContentLoaded', function() {
        // ä» URL è·å– cache_key
        const urlParams = new URLSearchParams(window.location.search);
        const cacheKey = urlParams.get('cache_key') || '{{ cache_key }}';

        // åŠ è½½å›¾è°±æ•°æ®
        loadGraphData(cacheKey);
    });

    // åŠ è½½å›¾è°±æ•°æ®
    async function loadGraphData(cacheKey) {
        try {
            const response = await fetch(`/api/graph-data?cache_key=${encodeURIComponent(cacheKey)}`);
            const result = await response.json();

            if (!response.ok || !result.success) {
                throw new Error(result.error || 'åŠ è½½å›¾è°±æ•°æ®å¤±è´¥');
            }

            // åˆå§‹åŒ– GraphEditor
            GraphEditor.initWithGraphData(result.data, result.physics);

        } catch (error) {
            console.error('åŠ è½½å›¾è°±å¤±è´¥:', error);
            const container = document.getElementById('mynetwork');
            container.innerHTML = `<div style="text-align: center; padding: 50px; color: #ff6b6b;">
                âŒ åŠ è½½å›¾è°±å¤±è´¥: ${error.message}
            </div>`;
        }
    }
</script>
</body>
</html>
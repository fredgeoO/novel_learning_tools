<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PyVis Frame</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/grapg_frame.css') }}">
    <style>
        #mynetwork {
            width: 100%;
            height: 80vh;
            border: 1px solid lightgray;
            position: relative;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            margin-right: 10px;
            padding: 6px 12px;
        }

        /* 右键菜单样式 */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .context-menu ul {
            list-style: none;
            padding: 5px 0;
            margin: 0;
        }

        .context-menu li {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
        }

        .context-menu li:hover {
            background-color: #f0f0f0;
        }

        .context-menu li.separator {
            border-top: 1px solid #eee;
            margin: 5px 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <h1>交互式图谱编辑器</h1>

    <div class="controls">
        <button onclick="cancelMode()">取消模式</button>
        <button onclick="addNodeMode()">添加节点</button>
        <div id="debug-info" style="margin-top: 10px; font-size: 14px; color: #aaa;"></div>
    </div>

    <div id="mynetwork"></div>

    <div id="nodeContextMenu" class="context-menu">
        <ul>
            <li onclick="deleteSelectedNode()">删除节点</li>
            <li class="separator"></li>
            <li onclick="createNewNodeFromSelected()">从此节点创建新节点</li>
            <li onclick="connectToNewNode()">连接到新节点</li>
            <li class="separator"></li>
            <li onclick="startConnectionFromNode()">从此节点创建连接</li>
            <li onclick="editNodeLabel()">编辑节点标签</li>
        </ul>
    </div>

    <!-- 修复了 URL 末尾的空格 -->
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <script>
        let network, nodes, edges;
        let selectedNode = null;
        let contextMenuNode = null;
        let addingNode = false; // 添加节点模式标志
        const contextMenu = document.getElementById('nodeContextMenu');
        const container = document.getElementById('mynetwork');

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 先显示一个简单的测试图，确保基本功能正常
            initTestGraph();
        });

        function initTestGraph() {
            // 创建测试数据
            const testData = {
                nodes: [
                    {id: 1, label: '节点1'},
                    {id: 2, label: '节点2'},
                    {id: 3, label: '节点3'}
                ],
                edges: [
                    {from: 1, to: 2},
                    {from: 2, to: 3}
                ]
            };

            initGraph(testData, true);
        }

        function loadGraphData() {
            const urlParams = new URLSearchParams(window.location.search);
            const cacheKey = urlParams.get('cache_key') || '{{ cache_key }}';

            fetch(`/api/graph-data?cache_key=${cacheKey}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        initGraph(result.data, result.physics);
                    } else {
                        container.innerHTML =
                            '<div style="text-align: center; padding: 50px; color: red;">加载失败: ' + result.error + '</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 50px; color: red;">加载错误: ' + error.message + '</div>';
                });
        }

        function initGraph(graphData, physicsEnabled) {
            try {
                nodes = new vis.DataSet(graphData.nodes || []);
                edges = new vis.DataSet(graphData.edges || []);

                const data = { nodes, edges };

                const options = {
                    physics: {
                        enabled: physicsEnabled !== undefined ? physicsEnabled : true,
                        stabilization: { iterations: 100 }
                    },
                    interaction: {
                        dragNodes: true,
                        dragView: true,
                        zoomView: true,
                        hover: true,
                        tooltipDelay: 200
                    },
                    nodes: {
                        shape: 'dot',
                        size: 16,
                        font: {
                            size: 14,
                            color: '#ffffff',
                            face: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif'
                        }
                    },
                    edges: {
                        arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                        smooth: { enabled: true },
                        color: { color: '#666666' }
                    }
                };

                // 清空容器
                container.innerHTML = '';

                network = new vis.Network(container, data, options);
                bindNetworkEvents();
            } catch (error) {
                console.error('初始化图失败:', error);
                container.innerHTML = '<div style="text-align: center; padding: 50px; color: red;">初始化图失败: ' + error.message + '</div>';
            }
        }

        function bindNetworkEvents() {
            if (!network) return;

            // 右键菜单 - 使用正确的事件
            network.on("oncontext", function (params) {
                console.log('右键点击事件触发');
                params.event.preventDefault();

                const nodeId = params.nodes.length > 0 ? params.nodes[0] : null;
                if (nodeId) {
                    contextMenuNode = nodeId;
                    selectedNode = nodeId;
                    const node = nodes.get(nodeId);
                    updateDebugInfo(`右键点击节点: ${node.label} (ID: ${node.id})`);
                    showContextMenu(params.pointer.DOM);
                } else {
                    updateDebugInfo("右键点击画布空白处");
                    hideContextMenu();
                }
            });

            // 左键点击
            network.on("click", function (params) {
                console.log('左键点击事件触发');
                selectedNode = params.nodes.length > 0 ? params.nodes[0] : null;
                hideContextMenu();

                // 更新调试信息
                if (selectedNode) {
                    const node = nodes.get(selectedNode);
                    updateDebugInfo(`点击节点: ${node.label} (ID: ${node.id})`);
                } else {
                    updateDebugInfo("点击画布空白处");
                }

                // 如果在添加节点模式下
                if (addingNode) {
                    const label = prompt("节点名称:", "新节点");
                    if (label) {
                        const newNodeId = 'node_' + Date.now();
                        nodes.add({
                            id: newNodeId,
                            label: label,
                            x: params.pointer.canvas.x,
                            y: params.pointer.canvas.y
                        });
                    }
                    addingNode = false;
                }
            });

            // 双击节点编辑
            network.on("doubleClick", function (params) {
                console.log('双击事件触发');
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = nodes.get(nodeId);
                    updateDebugInfo(`双击节点: ${node.label} (ID: ${node.id})`);
                    const newLabel = prompt("编辑节点名称:", node.label);
                    if (newLabel !== null) {
                        nodes.update({ id: nodeId, label: newLabel });
                    }
                }
            });

            // 点击事件（作为备用）
            network.on("selectNode", function (params) {
                console.log('选择节点事件触发');
                selectedNode = params.nodes.length > 0 ? params.nodes[0] : null;
                if (selectedNode) {
                    const node = nodes.get(selectedNode);
                    updateDebugInfo(`选择节点: ${node.label} (ID: ${node.id})`);
                }
            });
        }

        // 显示右键菜单
        function showContextMenu(domPos) {
            console.log('显示右键菜单');
            contextMenu.style.display = 'block';
            let x = domPos.x;
            let y = domPos.y;

            // 防止菜单超出屏幕
            const rect = contextMenu.getBoundingClientRect();
            if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 5;
            if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 5;

            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
        }

        // 隐藏右键菜单
        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        // 点击空白处隐藏菜单
        document.addEventListener('click', function (e) {
            if (!contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });

        // 按 ESC 键隐藏菜单
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                hideContextMenu();
                addingNode = false;
            }
        });

        // 右键菜单操作
        function deleteSelectedNode() {
            if (contextMenuNode) {
                const connectedEdges = network.getConnectedEdges(contextMenuNode);
                edges.remove(connectedEdges);
                nodes.remove(contextMenuNode);
                updateDebugInfo(`删除节点: ${contextMenuNode}`);
                hideContextMenu();
            }
        }

        function createNewNodeFromSelected() {
            if (contextMenuNode) {
                const label = prompt("节点名称:", "新节点");
                if (label) {
                    const newNodeId = 'node_' + Date.now();
                    const nodePos = network.getPositions([contextMenuNode])[contextMenuNode];
                    nodes.add({
                        id: newNodeId,
                        label: label,
                        x: nodePos.x + 100,
                        y: nodePos.y + 100
                    });
                    edges.add({
                        from: contextMenuNode,
                        to: newNodeId
                    });
                    updateDebugInfo(`从节点 ${contextMenuNode} 创建新节点: ${newNodeId}`);
                }
                hideContextMenu();
            }
        }

        function connectToNewNode() {
            createNewNodeFromSelected();
        }

        function startConnectionFromNode() {
            if (contextMenuNode && network) {
                network.addEdgeMode();
                updateDebugInfo(`进入连接模式，从节点: ${contextMenuNode}`);
                hideContextMenu();
            }
        }

        function editNodeLabel() {
            if (contextMenuNode) {
                const node = nodes.get(contextMenuNode);
                const newLabel = prompt("编辑节点名称:", node.label);
                if (newLabel !== null) {
                    nodes.update({ id: contextMenuNode, label: newLabel });
                    updateDebugInfo(`编辑节点标签: ${contextMenuNode} -> ${newLabel}`);
                }
                hideContextMenu();
            }
        }

        function cancelMode() {
            if (network) {
                network.disableEditMode();
            }
            addingNode = false;
            updateDebugInfo("已取消所有模式");
            hideContextMenu();
        }

        function addNodeMode() {
            addingNode = true;
            updateDebugInfo("进入添加节点模式，请点击画布添加节点");
            alert("请点击画布添加新节点");
        }

        // 更新调试信息的函数
        function updateDebugInfo(message) {
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.textContent = message;
            }
        }

        // 手动测试函数
        function testContextMenu() {
            // 模拟右键菜单显示
            contextMenu.style.display = 'block';
            contextMenu.style.left = '100px';
            contextMenu.style.top = '100px';
        }
    </script>
</body>
</html>